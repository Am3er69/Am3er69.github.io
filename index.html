<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Forex Signal Analyzer ‚Äî Live Ready</title>
  <style>
    body {
      font-family: "Poppins", Arial, sans-serif;
      background: #0a1224;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h1 {
      margin-top: 25px;
      font-size: 1.9em;
      color: #3cbefc;
    }
    button {
      background: #3cbefc;
      border: none;
      color: #fff;
      font-weight: bold;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 15px;
      transition: 0.3s;
    }
    button:hover {
      background: #2ca2d8;
    }
    .signal-card {
      background: #121c36;
      margin: 15px auto;
      padding: 15px;
      width: 85%;
      max-width: 520px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
      text-align: left;
    }
    .no-signal {
      color: #aaa;
      font-style: italic;
    }
    .volatility {
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 8px;
      display: inline-block;
      margin-top: 6px;
    }
    .low { background: #27ae60; }
    .medium { background: #f1c40f; color: #000; }
    .high { background: #e74c3c; }
    .confidence-container {
      background: #2b3558;
      border-radius: 8px;
      margin-top: 8px;
      overflow: hidden;
      height: 10px;
      width: 100%;
    }
    .confidence-bar {
      height: 10px;
      transition: width 0.6s ease;
      background: linear-gradient(90deg, #ff3c3c, #f1c40f, #27ae60);
    }
    footer {
      margin: 20px 0;
      color: #ccc;
      font-size: 0.9em;
    }
    #loading {
      color: #3cbefc;
      margin-top: 20px;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>AI Forex Signal Analyzer ‚Äî Live Ready üíπ</h1>
  <button onclick="generateSignals()">üîÑ Refresh Signals</button>
  <div id="loading" style="display:none;">Analyzing market conditions...</div>
  <div id="signals"></div>
  <footer id="lastUpdated"></footer>

  <script>
    const pairs = ["EUR/USD", "GBP/USD", "USD/JPY", "AUD/USD", "XAU/USD"];
    const signalsDiv = document.getElementById("signals");
    const lastUpdated = document.getElementById("lastUpdated");
    const loadingDiv = document.getElementById("loading");
    const API_KEY = "318e2543fba14c57836adc5ce228ee7e"; // Your Twelve Data API key

    const symbolMap = {
      "EUR/USD": "EUR/USD",
      "GBP/USD": "GBP/USD",
      "USD/JPY": "USD/JPY",
      "AUD/USD": "AUD/USD",
      "XAU/USD": "XAU/USD"
    };

    // Account & risk settings
    const ACCOUNT_BALANCE = 1000; // $1000
    const RISK_PERCENT = 0.01;    // 1% risk per trade
    const RISK_AMOUNT = ACCOUNT_BALANCE * RISK_PERCENT; // $10

    // Helper: get pip size
    function getPipSize(pair) {
      return pair === "XAU/USD" || pair === "USD/JPY" ? 0.01 : 0.0001;
    }

    // Helper: format price
    function formatPrice(price, pair) {
      const decimals = (pair === "USD/JPY" || pair === "XAU/USD") ? 2 : 5;
      return parseFloat(price).toFixed(decimals);
    }

    // Fetch 15-minute OHLC + indicators from Twelve Data
    async function fetchCandlesAndIndicators(pair) {
      const symbol = symbolMap[pair];
      if (!symbol) return null;

      const interval = "15min";
      const outputsize = 100;

      const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=${interval}&outputsize=${outputsize}&apikey=${API_KEY}`;

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (!data.values || data.values.length < 30) return null;

        // Calculate EMA(200), RSI(14), ATR(14)
        const closes = data.values.map(v => parseFloat(v.close));
        const highs = data.values.map(v => parseFloat(v.high));
        const lows = data.values.map(v => parseFloat(v.low));

        // Simple EMA(200)
        const ema200 = calculateEMA(closes, 200);
        const currentPrice = closes[0];
        const rsi = calculateRSI(closes, 14);
        const atr = calculateATR(highs, lows, closes, 14);

        return { currentPrice, ema200, rsi, atr, lastClose: closes[1] };
      } catch (err) {
        console.error(`Error fetching data for ${pair}:`, err);
        return null;
      }
    }

    // Simple EMA calculation
    function calculateEMA(prices, period) {
      if (prices.length < period) return null;
      let multiplier = 2 / (period + 1);
      let ema = prices.slice(0, period).reduce((a, b) => a + b, 0) / period;
      for (let i = period; i < prices.length; i++) {
        ema = (prices[i] - ema) * multiplier + ema;
      }
      return ema;
    }

    // RSI calculation
    function calculateRSI(prices, period) {
      if (prices.length <= period) return 50;
      let gains = 0, losses = 0;
      for (let i = prices.length - period; i < prices.length - 1; i++) {
        const diff = prices[i + 1] - prices[i];
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      gains /= period;
      losses /= period;
      if (losses === 0) return 100;
      const rs = gains / losses;
      return 100 - (100 / (1 + rs));
    }

    // ATR calculation
    function calculateATR(highs, lows, closes, period) {
      if (closes.length <= period) return 0.001;
      let trSum = 0;
      for (let i = closes.length - period; i < closes.length; i++) {
        const tr = Math.max(
          highs[i] - lows[i],
          Math.abs(highs[i] - (i > 0 ? closes[i - 1] : closes[i])),
          Math.abs(lows[i] - (i > 0 ? closes[i - 1] : closes[i]))
        );
        trSum += tr;
      }
      return trSum / period;
    }

    // Generate real signal based on strategy
    async function generateSignals() {
      signalsDiv.innerHTML = "";
      loadingDiv.style.display = "block";
      lastUpdated.innerHTML = "";

      const signalCards = [];

      for (const pair of pairs) {
        const data = await fetchCandlesAndIndicators(pair);
        if (!data) {
          signalCards.push(`<div class="signal-card"><b>${pair}</b><br><span class="no-signal">‚ö†Ô∏è Data unavailable</span></div>`);
          continue;
        }

        const { currentPrice, ema200, rsi, atr } = data;
        const pipSize = getPipSize(pair);
        const entry = currentPrice;
        let signalType = null;
        let slPips = null;

        // Strategy logic
        if (ema200 && entry > ema200 && rsi < 35) {
          signalType = "BUY";
          slPips = Math.max(12, Math.round(atr / pipSize * 1.5)); // SL = 1.5√óATR in pips
        } else if (ema200 && entry < ema200 && rsi > 65) {
          signalType = "SELL";
          slPips = Math.max(12, Math.round(atr / pipSize * 1.5));
        }

        if (!signalType) {
          signalCards.push(`<div class="signal-card"><b>${pair}</b><br><span class="no-signal">‚è∏Ô∏è No valid signal</span></div>`);
          continue;
        }

        // Calculate SL, TP, RR
        const slPrice = signalType === "BUY" 
          ? entry - slPips * pipSize 
          : entry + slPips * pipSize;
        const tpPips = Math.round(slPips * 1.5); // RR = 1.5
        const tpPrice = signalType === "BUY"
          ? entry + tpPips * pipSize
          : entry - tpPips * pipSize;

        // Position size (standard lot = $10 per pip for forex, $0.10 for XAU/USD per 0.01)
        const pipValue = pair === "XAU/USD" ? 0.10 : 10; // $ per pip per standard lot
        const riskPerLot = slPips * pipValue;
        const lotSize = Math.max(0.01, Math.min(1.00, (RISK_AMOUNT / riskPerLot).toFixed(2)));

        // Confidence based on RSI extremity + ATR strength
        const rsiStrength = signalType === "BUY" ? (35 - rsi) : (rsi - 65);
        const confidence = Math.min(95, Math.max(50, 50 + rsiStrength * 2 + (atr > 0.001 ? 10 : 0)));
        const volClass = atr > (pair === "XAU/USD" ? 5 : pair === "USD/JPY" ? 0.3 : 0.0015) ? "high" : 
                         atr > (pair === "XAU/USD" ? 2 : pair === "USD/JPY" ? 0.15 : 0.0007) ? "medium" : "low";

        signalCards.push(`
          <div class="signal-card">
            <b>${pair}</b> | <span style="color:${signalType==='BUY'?'#27ae60':'#e74c3c'}">${signalType}</span><br>
            Entry: ${formatPrice(entry, pair)} | SL: ${formatPrice(slPrice, pair)} | TP: ${formatPrice(tpPrice, pair)} | RR: 1.5<br>
            Lot Size: ${lotSize} | Risk: $${RISK_AMOUNT.toFixed(2)}<br>
            <span class="volatility ${volClass}">ATR Volatility</span><br>
            Confidence: ${Math.round(confidence)}% 
            <div class="confidence-container">
              <div class="confidence-bar" style="width:${confidence}%"></div>
            </div>
          </div>
        `);
      }

      signalsDiv.innerHTML = signalCards.join('');
      loadingDiv.style.display = "none";
      const now = new Date();
      lastUpdated.innerHTML = `Last updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    }

    generateSignals();
  </script>
</body>
</html>
