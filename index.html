<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Signal Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
    body {
        background: #0f0f0f;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    #statusBar {
        padding: 14px;
        font-size: 15px;
        background: #1c1c1c;
        border-bottom: 1px solid #333;
        text-align: center;
    }

    #signalContainer {
        padding: 15px;
    }

    .signal-card {
        background: #1b1b1b;
        padding: 15px;
        margin: 12px 0;
        border-radius: 12px;
        border: 1px solid #333;
        box-shadow: 0 0 12px rgba(0,0,0,0.4);
        transition: 0.2s ease-in-out;
    }

    .signal-card:hover {
        transform: scale(1.02);
    }

    .pair {
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .direction {
        font-size: 18px;
        margin-top: 5px;
        font-weight: bold;
    }

    .confidence {
        margin-top: 8px;
        font-size: 16px;
        color: #d0d0d0;
    }

    .details {
        margin-top: 12px;
        font-size: 14px;
        line-height: 1.5;
        color: #cfcfcf;
    }

    .timestamp {
        margin-top: 10px;
        font-size: 12px;
        opacity: 0.6;
        text-align: right;
        padding-right: 4px;
    }

    .no-signal {
        text-align: center;
        margin-top: 40px;
        font-size: 18px;
        opacity: 0.7;
    }
</style>
</head>

<body>

<div id="statusBar">Loading signalsâ€¦</div>
<div id="signalContainer"></div>

<script>
/*
  Updated frontend: points to your Render backend.
  Make sure your backend exposes GET /signals returning:
  { signals: [ { symbol, direction, confidence, entry, stopLoss, tp1, tp2, tp3, timestamp }, ... ] }
*/

// ------------------------------
// FRONTEND CONFIG
// ------------------------------
const API_URL = "https://backtesting-vlun.onrender.com"; // <-- updated to your Render URL
const MIN_CONFIDENCE = 65;
const REFRESH_MS = 10000; // 10s auto-refresh

// ------------------------------
// DOM ELEMENTS
// ------------------------------
const signalContainer = document.getElementById("signalContainer");
const statusBar = document.getElementById("statusBar");

// ------------------------------
// FETCH LIVE SIGNALS
// ------------------------------
async function fetchSignals() {
    try {
        statusBar.innerText = "Fetching signalsâ€¦";

        const res = await fetch(`${API_URL}/signals`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        statusBar.innerText = `Last Updated: ${new Date().toLocaleTimeString()}`;

        // backend may return signals in different property names; try a few safe fallbacks
        const signals = data.signals || data.results || data || [];
        renderSignals(signals);

    } catch (err) {
        console.error(err);
        statusBar.innerText = "Error fetching signals (Backend Offline?)";
        signalContainer.innerHTML = `<div class="no-signal">Backend offline or returned invalid data.</div>`;
    }
}

// ------------------------------
// RENDER SIGNAL CARDS
// ------------------------------
function renderSignals(signals) {
    signalContainer.innerHTML = "";

    // normalize incoming signal objects (be forgiving)
    const normalized = signals.map(s => ({
        symbol: s.symbol || s.pair || s.symbolName || s.key || "unknown",
        direction: (s.direction || s.signal || s.candidate || "NONE"),
        confidence: Number(s.confidence ?? s.combinedConfidence ?? s.internalConfidence ?? 0),
        entry: s.entry ?? s.price ?? "â€”",
        stopLoss: s.stopLoss ?? s.slPrice ?? s.sl ?? "â€”",
        tp1: s.tp1 ?? s.tpPrice ?? s.tp ?? "â€”",
        tp2: s.tp2 ?? s.tp2 ?? "â€”",
        tp3: s.tp3 ?? s.tp3 ?? "â€”",
        timestamp: s.timestamp || s.lastCandleTime || Date.now()
    }));

    const filtered = normalized.filter(s => s.confidence >= MIN_CONFIDENCE);

    if (filtered.length === 0) {
        signalContainer.innerHTML = `
            <div class="no-signal">No high-confidence signals (â‰¥ ${MIN_CONFIDENCE}%)</div>
        `;
        return;
    }

    filtered.forEach(sig => {
        const card = document.createElement("div");
        card.className = "signal-card";

        const arrow = sig.direction === "BUY" ? "ðŸ“ˆ" : sig.direction === "SELL" ? "ðŸ“‰" : "âšª";
        const color = sig.direction === "BUY" ? "#1eae60" : "#d9534f";

        card.innerHTML = `
            <div class="pair">${sig.symbol}</div>
            <div class="direction" style="color:${color}">${arrow} ${sig.direction}</div>
            <div class="confidence">Confidence: <b>${sig.confidence}%</b></div>

            <div class="details">
                <div>Entry: ${formatNumber(sig.entry)}</div>
                <div>Stop Loss: ${formatNumber(sig.stopLoss)}</div>
                <div>TP1: ${formatNumber(sig.tp1)}</div>
                <div>TP2: ${formatNumber(sig.tp2)}</div>
                <div>TP3: ${formatNumber(sig.tp3)}</div>
            </div>

            <div class="timestamp">
                Generated: ${new Date(sig.timestamp).toLocaleString()}
            </div>
        `;

        signalContainer.appendChild(card);
    });
}

function formatNumber(v){
    if (v === null || v === undefined) return "â€”";
    if (typeof v === "number") return v.toFixed((v % 1 === 0) ? 0 : 5);
    // try numeric conversion for strings
    const n = Number(v);
    if (!isNaN(n)) return n.toFixed((n % 1 === 0) ? 0 : 5);
    return v;
}

// ------------------------------
// AUTO REFRESH
// ------------------------------
setInterval(fetchSignals, REFRESH_MS);
fetchSignals();
</script>

</body>
</html>
