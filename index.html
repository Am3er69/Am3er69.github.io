// =========================
// CONFIG
// =========================
const API_KEY = "318e2543fba14c57836adc5ce228ee7e";
const BACKEND_URL = "http://localhost:3000/backtest"; // Node server
const REFRESH_INTERVAL = 10000; // refresh every 10s

// Don't show signals below this confidence %
const CONFIDENCE_THRESHOLD = 65;

// Pairs we now support
const PAIRS = [
    "XAU/USD", "EUR/USD", "GBP/USD", "USD/JPY", "GBP/JPY",
    "EUR/JPY", "EUR/GBP", "GBP/AUD", "BTC/USD", "ETH/USD"
];

// =========================
// Fetch Market Data
// =========================
async function fetchTwelveData(symbol) {
    try {
        const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1min&apikey=${API_KEY}&outputsize=50`;
        const res = await fetch(url);
        const data = await res.json();
        return data.values ? data.values.reverse() : null;
    } catch (err) {
        console.error("❌ API Error:", err);
        return null;
    }
}

// =========================
// Simple Indicators
// =========================
function SMA(values, length) {
    if (values.length < length) return null;
    const slice = values.slice(-length);
    const sum = slice.reduce((a, b) => a + parseFloat(b.close), 0);
    return sum / length;
}

function RSI(values, period = 14) {
    if (values.length < period + 1) return null;

    let gains = 0, losses = 0;
    for (let i = values.length - period; i < values.length; i++) {
        const diff = values[i].close - values[i - 1].close;
        if (diff > 0) gains += diff;
        else losses -= diff;
    }

    const rs = gains / (losses === 0 ? 1 : losses);
    return 100 - 100 / (1 + rs);
}

// =========================
// Signal Logic
// =========================
function generateSignal(candles) {
    const sma5 = SMA(candles, 5);
    const sma20 = SMA(candles, 20);
    const rsi = RSI(candles, 14);
    const last = candles[candles.length - 1].close;

    let signal = "NONE";
    let confidence = 50;

    // Trend logic
    if (sma5 > sma20) {
        signal = "BUY";
        confidence += 10;
    } else if (sma5 < sma20) {
        signal = "SELL";
        confidence += 10;
    }

    // RSI adjustments
    if (rsi < 30 && signal === "BUY") confidence += 15;
    if (rsi > 70 && signal === "SELL") confidence += 15;

    return {
        signal,
        confidence: Math.min(confidence, 100),
        price: last,
        sma5,
        sma20,
        rsi
    };
}

// =========================
// Fetch Node Backtest
// =========================
async function fetchBacktest(symbol) {
    try {
        const url = `${BACKEND_URL}?symbol=${symbol}`;
        const result = await fetch(url).then(res => res.json());
        return result;
    } catch (err) {
        console.error("❌ Backtest Error:", err);
        return null;
    }
}

// =========================
— Render Signals
// =========================
function renderSignalCard(symbol, data, backtest) {
    const container = document.getElementById("signals");

    const card = document.createElement("div");
    card.className = "signal-card";

    card.innerHTML = `
        <h2>${symbol}</h2>
        <p><strong>Signal:</strong> ${data.signal}</p>
        <p><strong>Confidence:</strong> ${data.confidence}%</p>
        <p><strong>Price:</strong> ${data.price}</p>

        <hr>

        <p><strong>SMA5:</strong> ${data.sma5.toFixed(2)}</p>
        <p><strong>SMA20:</strong> ${data.sma20.toFixed(2)}</p>
        <p><strong>RSI:</strong> ${data.rsi.toFixed(2)}</p>

        <hr>

        <p><strong>Backtest Wins:</strong> ${backtest?.wins ?? "?"}</p>
        <p><strong>Backtest Losses:</strong> ${backtest?.losses ?? "?"}</p>
    `;

    container.appendChild(card);
}

// =========================
// Load All Signals
// =========================
async function loadSignals() {
    document.getElementById("signals").innerHTML = "";

    for (const pair of PAIRS) {
        const candles = await fetchTwelveData(pair);
        if (!candles) continue;

        const analysis = generateSignal(candles);

        // ❌ filter out weak signals
        if (analysis.confidence < CONFIDENCE_THRESHOLD) continue;

        // backend backtest
        const backtest = await fetchBacktest(pair);

        renderSignalCard(pair, analysis, backtest);
    }
}

// =========================
// Start
// =========================
loadSignals();
setInterval(loadSignals, REFRESH_INTERVAL);
